{% extends "base.html" %}
{% block title %}{{ vehicle.plate }} - Detalle Vehículo{% endblock %}
{% block content %}
<h1 class="h3 mb-4">
    <a href="{{ url_for('web.vehicle_list') }}" class="text-decoration-none me-2">←</a>
    {{ vehicle.plate }}
    {% if vehicle.alias %}<small class="text-muted">({{ vehicle.alias }})</small>{% endif %}
</h1>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted small">Combustible (mes)</div>
                <h4 class="mb-0">{{ "%.1f"|format(kpis_month.fuel_liters) }} L</h4>
                <small class="text-muted">{{ "%.2f"|format(kpis_month.fuel_total) }} €</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted small">Gastos (mes)</div>
                <h4 class="mb-0">{{ "%.2f"|format(kpis_month.expenses_total) }} €</h4>
                <small class="text-muted">Base: {{ "%.2f"|format(kpis_month.expenses_subtotal) }} € + IVA: {{ "%.2f"|format(kpis_month.expenses_tax) }} €</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted small">Combustible (año)</div>
                <h4 class="mb-0">{{ "%.1f"|format(kpis_year.fuel_liters) }} L</h4>
                <small class="text-muted">{{ "%.2f"|format(kpis_year.fuel_total) }} €</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted small">Gastos (año)</div>
                <h4 class="mb-0">{{ "%.2f"|format(kpis_year.expenses_total) }} €</h4>
            </div>
        </div>
    </div>
</div>

{% if consumption_stats.liters_per_100km %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted small">Consumo (L/100km)</div>
                <h4 class="mb-0">{{ "%.2f"|format(consumption_stats.liters_per_100km) }} L/100km</h4>
                <small class="text-muted">{{ consumption_stats.total_km }} km recorridos</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted small">Coste por km</div>
                <h4 class="mb-0">{{ "%.4f"|format(consumption_stats.cost_per_km) }} €/km</h4>
                <small class="text-muted">{{ "%.2f"|format(consumption_stats.total_cost) }} € total</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted small">Litros consumidos</div>
                <h4 class="mb-0">{{ "%.1f"|format(consumption_stats.total_liters) }} L</h4>
                <small class="text-muted">En {{ consumption_stats.total_km }} km</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">Información del vehículo</div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr><th>Matrícula</th><td>{{ vehicle.plate }}</td></tr>
                    {% if vehicle.alias %}<tr><th>Alias</th><td>{{ vehicle.alias }}</td></tr>{% endif %}
                    {% if vehicle.brand %}<tr><th>Marca</th><td>{{ vehicle.brand }}</td></tr>{% endif %}
                    {% if vehicle.model %}<tr><th>Modelo</th><td>{{ vehicle.model }}</td></tr>{% endif %}
                    {% if vehicle.category %}<tr><th>Categoría</th><td><span class="badge bg-info">{{ vehicle.category|title }}</span></td></tr>{% endif %}
                    <tr><th>Estado</th><td>{% if vehicle.active %}<span class="badge bg-success">Activo</span>{% else %}<span class="badge bg-secondary">Inactivo</span>{% endif %}</td></tr>
                </table>
                <a href="{{ url_for('web.vehicle_edit', vid=vehicle.id) }}" class="btn btn-sm btn-outline-secondary">Editar</a>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">Vencimientos</div>
            <div class="card-body">
                {% if reminders %}
                <table class="table table-sm">
                    <thead><tr><th>Tipo</th><th>Vencimiento</th><th>Días</th></tr></thead>
                    <tbody>
                        {% for r in reminders %}
                        <tr>
                            <td>{{ r.kind }}</td>
                            <td>{{ r.due_date|date_format }}</td>
                            <td>
                                {% if r.days_remaining < 0 %}
                                <span class="badge bg-danger">Vencido ({{ -r.days_remaining }})</span>
                                {% elif r.days_remaining <= 7 %}
                                <span class="badge bg-danger">{{ r.days_remaining }}</span>
                                {% elif r.days_remaining <= 30 %}
                                <span class="badge bg-warning">{{ r.days_remaining }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ r.days_remaining }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">No hay vencimientos registrados.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">Gastos por categoría (año actual)</div>
            <div class="card-body">
                {% if expenses_by_category %}
                <table class="table table-sm">
                    <thead><tr><th>Categoría</th><th>Base</th><th>IVA</th><th>Total</th></tr></thead>
                    <tbody>
                        {% for e in expenses_by_category %}
                        <tr>
                            <td>{{ e.category }}</td>
                            <td>{% if e.subtotal_amount %}{{ "%.2f"|format(e.subtotal_amount) }} €{% else %}-{% endif %}</td>
                            <td>{% if e.tax_amount %}{{ "%.2f"|format(e.tax_amount) }} €{% else %}-{% endif %}</td>
                            <td>{{ "%.2f"|format(e.total_amount) }} €</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">Sin gastos registrados.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">Consumo por mes (año actual)</div>
            <div class="card-body">
                {% if fuel_by_month %}
                <table class="table table-sm">
                    <thead><tr><th>Mes</th><th>Litros</th><th>Base</th><th>IVA</th><th>Total</th></tr></thead>
                    <tbody>
                        {% for f in fuel_by_month %}
                        <tr>
                            <td>{{ f.month }}</td>
                            <td>{{ "%.1f"|format(f.total_liters) }}</td>
                            <td>{% if f.subtotal_amount %}{{ "%.2f"|format(f.subtotal_amount) }} €{% else %}-{% endif %}</td>
                            <td>{% if f.tax_amount %}{{ "%.2f"|format(f.tax_amount) }} €{% else %}-{% endif %}</td>
                            <td>{{ "%.2f"|format(f.total_amount) }} €</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">Sin consumo registrado.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">Últimas intervenciones (taller)</div>
            <div class="card-body">
                {% if workshop_expenses %}
                <table class="table table-sm">
                    <thead><tr><th>Fecha</th><th>Proveedor</th><th>Importe</th></tr></thead>
                    <tbody>
                        {% for w in workshop_expenses %}
                        <tr>
                            <td>{{ w.date|date_format }}</td>
                            <td>{{ w.vendor or '-' }}</td>
                            <td>{{ "%.2f"|format(w.total_amount) }} €</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">Sin intervenciones registradas.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">Últimos documentos</div>
            <div class="card-body">
                {% if recent_documents %}
                <table class="table table-sm">
                    <thead><tr><th>Fecha</th><th>Tipo</th><th>Estado</th><th></th></tr></thead>
                    <tbody>
                        {% for d in recent_documents %}
                        <tr>
                            <td>{{ d.uploaded_at|date_format }}</td>
                            <td>{{ d.doc_type or '-' }}</td>
                            <td>
                                {% if d.status == 'processed' %}<span class="badge bg-success">Procesado</span>
                                {% elif d.status == 'pending' %}<span class="badge bg-warning">Pendiente</span>
                                {% else %}<span class="badge bg-danger">Error</span>{% endif %}
                            </td>
                            <td><a href="{{ url_for('web.document_detail', did=d.id) }}" class="btn btn-sm btn-outline-primary">Ver</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">Sin documentos registrados.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.vehicle-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

